---
// src/components/BaseLayout.astro
import CookieConsent from './CookieConsent.astro';
import LanguageSwitcher from './LanguageSwitcher.astro';
import { buildAlternateUrls, detectLocale, localeOgMap } from '../utils/locales';
export interface Props {
  title: string;
  description?: string;
  ogImage?: string;
}

const {
  title,
  description = "Kunke Consulting: wdrożenia sztucznej inteligencji, automatyzacje procesów i doradztwo dla firm",
  ogImage
} = Astro.props;

const nonce: string | undefined = Astro.locals?.nonce;

// safer attr helper: Astro renders empty attrs if value is undefined, which is OK.
const siteUrl = Astro.site;
const absoluteOgImage = ogImage
  ? new URL(ogImage, siteUrl).href
  : new URL('/images/Kunke_Favicon.png', siteUrl).href;

const canonicalUrl = Astro.url.href;
const currentLocale = detectLocale(Astro.url.pathname);
const alternateUrls = buildAlternateUrls(Astro.url.pathname, siteUrl);
const xDefaultUrl = alternateUrls.find(({ locale }) => locale === 'en')?.href ?? canonicalUrl;
const ogLocale = localeOgMap[currentLocale] ?? 'pl_PL';
---

<!DOCTYPE html>
<html lang={currentLocale}>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>{title}</title>
  <meta name="description" content={description} />

  <link rel="canonical" href={canonicalUrl} />
  {alternateUrls.map(({ locale, href }) => (
    <link rel="alternate" hreflang={locale} href={href} />
  ))}
  <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />

  <!-- OG/Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content={ogLocale} />
  <meta property="og:site_name" content="Kunke Consulting" />
  <meta property="og:url" content={Astro.url.href} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={absoluteOgImage} />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={Astro.url.href} />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={absoluteOgImage} />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/Kunke_Favicon.png" />
  <link rel="shortcut icon" href="/favicon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- Resource hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Load fonts WITHOUT inline onload handler -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">

  <!-- Google Tag Manager (init dataLayer before loader for Consent Mode etc.) -->
  <script nonce={nonce}>
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      'gtm.start': new Date().getTime(),
      event: 'gtm.js'
    });
    (function(){
      function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
        return match ? match[2] : null;
      }
      const consent = getCookie('cookie_consent') === 'granted' ? 'granted' : 'denied';
      window.dataLayer.push({
        event: 'default_consent_set',
        consent: {
          ad_storage: consent,
          analytics_storage: consent,
          wait_for_update: 500
        }
      });
    })();
  </script>
  <script nonce={nonce}>
    (function(w,d,s,l,i){
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MWRKLP2S');
  </script>
  <!-- End GTM -->

  <!-- Critical CSS (nonce ok) -->
  <style nonce={nonce}>
    /* … your CSS unchanged … */

    /* Move noscript iframe inline style to class to avoid style-src 'unsafe-inline' */
    .gtm-noscript { display:none; visibility:hidden; width:0; height:0; }
  </style>

  <!-- Non-blocking load for global stylesheet -->
  <link
    rel="preload"
    href="/styles/global.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript><link rel="stylesheet" href="/styles/global.css" /></noscript>
  
  <!-- JSON-LD: Organization & LocalBusiness -->
  <script type="application/ld+json" nonce={nonce}>
  {
    "@context": "https://schema.org",
    "@type": ["LocalBusiness", "ProfessionalService"],
    "@id": "https://kunkeconsulting.pl/#organization",
    "name": "Kunke Consulting",
    "alternateName": "^Kunke Consulting",
    "image": "https://kunkeconsulting.pl/images/Kunke_Favicon.png",
    "logo": "https://kunkeconsulting.pl/images/Kunke_Favicon.png",
    "description": "Warsztaty i szkolenia AI dla średnich firm w Polsce i Europie. Praktyczne wdrożenia sztucznej inteligencji, automatyzacje procesów biznesowych i doradztwo AI dla zespołów 20-500 osób.",
    "url": "https://kunkeconsulting.pl",
    "telephone": "+48722156925",
    "email": "info@kunkeconsulting.pl",
    "foundingDate": "2023",
    "founder": {
      "@type": "Person",
      "name": "Błażej Kunke",
      "jobTitle": "AI Trainer & Consultant",
      "url": "https://www.linkedin.com/in/blazejkunke/"
    },
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "PL",
      "addressLocality": "Warszawa",
      "addressRegion": "Mazowieckie"
    },
    "geo": { "@type": "GeoCoordinates", "latitude": "52.2297", "longitude": "21.0122" },
    "openingHoursSpecification": {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday"],
      "opens": "09:00",
      "closes": "17:00"
    },
    "areaServed": [
      { "@type": "Country", "name": "Poland", "alternateName": "Polska" },
      { "@type": "Country", "name": "Germany", "alternateName": "Deutschland" },
      { "@type": "Country", "name": "Netherlands", "alternateName": "Nederland" },
      { "@type": "Country", "name": "France" },
      { "@type": "Country", "name": "Belgium", "alternateName": "België" },
      { "@type": "Country", "name": "Austria", "alternateName": "Österreich" },
      { "@type": "Country", "name": "Czech Republic", "alternateName": "Česká republika" },
      { "@type": "Country", "name": "Slovakia", "alternateName": "Slovensko" },
      { "@type": "Country", "name": "United Kingdom" },
      { "@type": "Country", "name": "Ireland" }
    ],
    "priceRange": "$$",
    "currenciesAccepted": "PLN, EUR",
    "paymentAccepted": "Bank Transfer, Invoice",
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.9",
      "reviewCount": "47",
      "bestRating": "5"
    },
    "knowsAbout": [
      "Artificial Intelligence",
      "Machine Learning",
      "ChatGPT",
      "Business Process Automation",
      "AI Training",
      "Digital Transformation",
      "GDPR Compliance for AI",
      "AI Act"
    ],
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Szkolenia i warsztaty AI dla firm",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Warsztaty AI dla firm",
            "alternateName": "AI Workshops for Business",
            "description": "Praktyczne warsztaty sztucznej inteligencji dla zespołów firmowych. Szkolenie ChatGPT, automatyzacja procesów, AI w codziennej pracy. Dla średnich i dużych przedsiębiorstw.",
            "provider": {"@type": "Organization", "name": "Kunke Consulting"},
            "serviceType": "AI Training",
            "areaServed": "Europe"
          },
          "priceSpecification": {
            "@type": "PriceSpecification",
            "price": "6000",
            "priceCurrency": "PLN",
            "minPrice": "6000"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Konsulting AI i wdrożenia",
            "alternateName": "AI Consulting & Implementation",
            "description": "Kompleksowe doradztwo AI dla firm: audyt procesów, polityka AI, zgodność z GDPR i AI Act, wdrożenie narzędzi AI. Idealne dla średnich przedsiębiorstw szukających transformacji cyfrowej.",
            "provider": {"@type": "Organization", "name": "Kunke Consulting"},
            "serviceType": "AI Consulting",
            "areaServed": "Europe"
          },
          "priceSpecification": {
            "@type": "PriceSpecification",
            "price": "11000",
            "priceCurrency": "PLN",
            "minPrice": "11000"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Program transformacji AI",
            "alternateName": "AI Transformation Program",
            "description": "Zaawansowany program wdrożenia AI dla większych organizacji. Seria warsztatów dla 20-100 osób, polityki AI dla działów, konsultacje prawne, projektowanie automatyzacji.",
            "provider": {"@type": "Organization", "name": "Kunke Consulting"},
            "serviceType": "Digital Transformation",
            "areaServed": "Europe"
          }
        }
      ]
    },
    "sameAs": [
      "https://www.linkedin.com/in/blazejkunke/",
      "https://www.facebook.com/blazej.kunke",
      "https://www.youtube.com/@BlazeAdventuresWorld"
    ]
  }
  </script>
</head>
<body>
  <!-- GTM noscript (no inline style) -->
  <noscript>
    <iframe class="gtm-noscript" src="https://www.googletagmanager.com/ns.html?id=GTM-MWRKLP2S"></iframe>
  </noscript>

  <LanguageSwitcher currentLocale={currentLocale} alternateUrls={alternateUrls} />

  <slot />
  <CookieConsent />
</body>
</html>
