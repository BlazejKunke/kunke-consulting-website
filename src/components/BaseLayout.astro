---
// src/components/BaseLayout.astro
import CookieConsent from './CookieConsent.astro';
import { getLangFromUrl, useTranslations } from '../utils/i18n';

export interface Props {
  ogImage?: string;
  // title and description are now handled by the layout based on the language
}

const { ogImage } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const nonce: string | undefined = Astro.locals?.nonce;

const siteUrl = Astro.site;
const absoluteOgImage = ogImage
  ? new URL(ogImage, siteUrl).href
  : new URL(t('site.ogImage'), siteUrl).href;

const title = t('site.title');
const description = t('site.description');

const slugTranslations: Record<string, string> = {
  'konsulting-ai': 'ai-consulting',
  'szkolenia-ai-online': 'ai-training-online',
  'szkolenia-ai-poznan': 'ai-training-poznan',
  'szkolenia-ai': 'ai-training',
  'zespol': 'team',
  'privacy-policy': 'privacy-policy',
  'blog': 'blog',
  'ai-excel': 'ai-excel',
};

const getAlternatePath = () => {
    const currentPath = Astro.url.pathname;
    const slug = currentPath.split('/').pop() || '';

    if (lang === 'en') {
        const plSlug = Object.keys(slugTranslations).find(key => slugTranslations[key] === slug);
        return `/${plSlug || ''}`;
    } else {
        const enSlug = slugTranslations[slug] || '';
        return `/en/${enSlug}`;
    }
};

const plUrl = lang === 'pl' ? Astro.url.pathname : getAlternatePath();
const enUrl = lang === 'en' ? Astro.url.pathname : getAlternatePath();

---

<!DOCTYPE html>
<html lang={lang}>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>{title}</title>
  <meta name="description" content={description} />

  <link rel="canonical" href={Astro.url.href} />
  <link rel="alternate" hreflang="pl" href={new URL(plUrl, Astro.site).href} />
  <link rel="alternate" hreflang="en" href={new URL(enUrl, Astro.site).href} />

  <!-- OG/Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={Astro.url.href} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={absoluteOgImage} />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={Astro.url.href} />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={absoluteOgImage} />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/Kunke_Favicon.png" />
  <link rel="shortcut icon" href="/favicon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- Resource hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Load fonts WITHOUT inline onload handler -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">

  <!-- Google Tag Manager (init dataLayer before loader for Consent Mode etc.) -->
  <script nonce={nonce}>
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      'gtm.start': new Date().getTime(),
      event: 'gtm.js'
    });
    (function(){
      function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
        return match ? match[2] : null;
      }
      const consent = getCookie('cookie_consent') === 'granted' ? 'granted' : 'denied';
      window.dataLayer.push({
        event: 'default_consent_set',
        consent: {
          ad_storage: consent,
          analytics_storage: consent,
          wait_for_update: 500
        }
      });
    })();
  </script>
  <script nonce={nonce}>
    (function(w,d,s,l,i){
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MWRKLP2S');
  </script>
  <!-- End GTM -->

  <!-- Critical CSS (nonce ok) -->
  <style nonce={nonce}>
    /* Move noscript iframe inline style to class to avoid style-src 'unsafe-inline' */
    .gtm-noscript { display:none; visibility:hidden; width:0; height:0; }
  </style>

  <!-- Non-blocking load for global stylesheet -->
  <link
    rel="preload"
    href="/styles/global.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript><link rel="stylesheet" href="/styles/global.css" /></noscript>
  
  <!-- JSON-LD MUST have nonce -->
  <script type="application/ld+json" nonce={nonce}>
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": "Kunke Consulting",
    "image": "/images/Kunke_Favicon.png",
    "description": "{lang === 'pl' ? 'Profesjonalne szkolenia AI i Excel dla firm w Polsce.' : 'Professional AI and Excel training for companies in Poland.'}",
    "url": "https://kunkeconsulting.pl",
    "telephone": "+48722156925",
    "email": "info@kunkeconsulting.pl",
    "address": { "@type": "PostalAddress", "addressCountry": "PL", "addressLocality": "Polska" },
    "geo": { "@type": "GeoCoordinates", "latitude": "52.2297", "longitude": "21.0122" },
    "openingHoursSpecification": { "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday"],
      "opens":"09:00","closes":"17:00"
    },
    "serviceArea": { "@type": "Country", "name": "Poland" },
    "hasOfferCatalog": { "@type": "OfferCatalog", "name":"Szkolenia AI i Excel",
      "itemListElement":[
        {"@type":"Offer","itemOffered":{"@type":"Course","name": "{lang === 'pl' ? 'Szkolenia AI dla firm' : 'AI Training for Companies'}","description":"{lang === 'pl' ? 'Praktyczne szkolenia sztucznej inteligencji dla polskich firm' : 'Practical artificial intelligence training for Polish companies'}" ,"provider":{"@type":"Organization","name":"Kunke Consulting"}}},
        {"@type":"Offer","itemOffered":{"@type":"Course","name":"{lang === 'pl' ? 'Szkolenia Excel z AI' : 'Excel Training with AI'}", "description":"{lang === 'pl' ? 'Kursy Excel z wykorzystaniem sztucznej inteligencji' : 'Excel courses using artificial intelligence'}", "provider":{"@type":"Organization","name":"Kunke Consulting"}}},
        {"@type":"Offer","itemOffered":{"@type":"Service","name":"{lang === 'pl' ? 'Konsulting AI' : 'AI Consulting'}", "description":"{lang === 'pl' ? 'Doradztwo w zakresie implementacji AI w firmie' : 'Consulting on AI implementation in the company'}", "provider":{"@type":"Organization","name":"Kunke Consulting"}}}
      ]
    },
    "sameAs": [
      "https://www.linkedin.com/in/blazejkunke/",
      "https://www.facebook.com/blazej.kunke",
      "https://www.youtube.com/@BlazeAdventuresWorld"
    ]
  }
  </script>
</head>
<body>
  <!-- GTM noscript (no inline style) -->
  <noscript>
    <iframe class="gtm-noscript" src="https://www.googletagmanager.com/ns.html?id=GTM-MWRKLP2S"></iframe>
  </noscript>

  <slot />
  <CookieConsent />

  <footer>
    <div class="footer-wrapper">
      <div class="footer-content">
        <div class="footer-section contact-info-footer">
          <h3>{t('footer.contact')}</h3>
          <p>^Kunke Consulting</p>
          <p><a href="mailto:info@kunkeconsulting.pl">info@kunkeconsulting.pl</a></p>
          <p><a href="tel:+48722156925">m. +48 722 156 925</a></p>
        </div>
        <div class="footer-section legal-info">
          <h3>{t('footer.legal')}</h3>
          <p><a href={lang === 'en' ? '/en/privacy-policy' : '/privacy-policy'}>{t('footer.privacy')}</a></p>
          <p><a href={lang === 'en' ? '/en/blog' : '/blog'} target="_blank" rel="noopener noreferrer">{t('footer.blog')}</a></p>
        </div>
        <div class="footer-section social-media">
          <h3>{t('footer.follow')}</h3>
          <ul>
            <li><a href="https://www.linkedin.com/in/blazejkunke/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li>
            <li><a href="https://www.facebook.com/blazej.kunke" target="_blank" rel="noopener noreferrer">Facebook</a></li>
            <li><a href="https://www.youtube.com/@BlazeAdventuresWorld" target="_blank" rel="noopener noreferrer">YouTube</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>{t('footer.copyright')}</p>
      <div class="language-switcher">
        <a href={`${plUrl}?lang=pl`}>{t('lang.pl')}</a> | <a href={`${enUrl}?lang=en`}>{t('lang.en')}</a>
      </div>
    </div>
  </footer>
  <style>
    footer {
      background: #f8f8fa;
      padding: 40px 0 0 0;
      text-align: center;
      width: 100%;
    }
    .footer-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .footer-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    .footer-section {
      min-width: 200px;
      text-align: center;
    }
    .footer-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .footer-section ul li {
      margin: 0 0 8px 0;
    }
    .footer-bottom {
      margin-top: 30px;
      padding: 20px 10px;
      background: #ececf2;
      font-size: 0.85em;
      color: #555;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }
    .language-switcher a {
      color: #555;
      text-decoration: none;
    }
  </style>
</body>
</html>
